(function(){var e,n;n=angular.module("tumblrGame.rounds"),e=function(){function e(e,n,o,t,r,s,c,a,u){var i,l,d,f,g,m;e.isLoading=!0,e.isSuccessful=!1,e.percentLoaded=0,e.round=r.get("current_round"),e.type=c.type||"series",g=n.random_tag(e.type),m=new RegExp("^#?"+g.regex.source+"$","i"),i=o.fromPastMonths(12),t.jsonp_query({tag:g.name,before:i},function(n){var o,t,r,s,c;for(e.message=n.meta,e.posts=[],c=n.response,r=0,s=c.length;s>r&&(t=c[r],!("photo"===t.type&&(e.posts.push(t),e.posts.length>=6)));r++);return o=e.posts.map(function(e){return e.photos[0].original_size.url})}),e.correct=!1,e.guess="",u.preloadImages(images).then(f=function(){var n;return e.isLoading=!1,e.isSuccessful=!0,console.info("Preload Successful"),e.roundStartTime=Date.now(),e.secondsLeft=20,e.$watch("guess",function(n){return n&&0!==n.length?(e.correct=-1!==n.search(m),e.correct):0}),e.$watch("correct",function(n){return n?(r.increment("current_round",1),e.stop(),s.transitionTo("end",{tag:g.name,before:i,win:!0})):void 0}),n=null,e.onTimeout=function(){return e.secondsLeft--,e.secondsLeft>=1?n=a(e.onTimeout,1e3):(e.stop(),s.transitionTo("end",{tag:g.name,before:i,win:!1}))},n=a(e.onTimeout,1e3),e.stop=function(){return a.cancel(n)}},d=function(n){return e.isLoading=!1,e.isSuccessful=!1,console.error("Image Failed",n),console.info("Preload Failure")},l=function(n){return e.percentLoaded=n.percent,console.info("Percent loaded:",n.percent)})}return e.$inject=["$scope","TagsService","RandomDateService","RoundsRes","gameStorage","$state","$stateParams","$timeout","ImagePreloader"],e}(),n.controller("RoundCtrl",e)}).call(this);