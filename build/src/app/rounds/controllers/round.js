(function(){var e,t,n,o,r=function(e,t){return function(){return e.apply(t,arguments)}};o=angular.module("tumblrGame.rounds"),n=function(e){return{restrict:"E",scope:{_modalShow:"&modalShow",_modalContent:"&modalContent"},template:e.get("rounds/views/modal.tpl.html")}},o.directive("modalView",["$templateCache",n]),t=function(e){var t;return new(t=function(){function t(){this.open=r(this.open,this),this.close=r(this.close,this),this.isOpen=r(this.isOpen,this)}return t.prototype.isOpen=function(){return!!this.content},t.prototype.content="",t.prototype.close=function(){return this.content=""},t.prototype.open=function(t){var n;return n=this,this.content=t,this.timeout=e(function(){return n.close()},2e6)},t}())},o.factory("Modal",["$timeout",t]),e=function(){function e(e,t,n,o,r,s,i,u,c,a,l){var p,d,f,m;e.isLoading=!0,e.isSuccessful=!1,e.percentLoaded=0,e.modal=l,Mousetrap.unbind("backspace").bind("backspace",function(e){var t,n;return t=e.srcElement||e.target,n="INPUT"===t.tagName.toUpperCase()&&"TEXT"===t.type.toUpperCase()?t.readOnly||t.disabled:!0,n?e.preventDefault():void 0}),Mousetrap.bind("enter",function(e){return e.preventDefault(),l.open("Wrong")}),e.round=s.get("current_round"),e.category=u.category,p=u.before,d=n.tag(e.category,u.index),f=new RegExp("^#?"+d.regex.source+"$","i"),e.posts=[],r.jsonp_query({tag:d.name,before:p},function(t){var n,o,r,s,i;for(e.message=t.meta,i=t.response,r=0,s=i.length;s>r&&(o=i[r],!("photo"===o.type&&(e.posts.push(o),e.posts.length>=6)));r++);return n=e.posts.map(function(e){return e.photos[0].alt_sizes[1].url}),a.preloadImages(n).then(function(){var t;return e.isLoading=!1,e.isSuccessful=!0,console.info("Preload Successful"),t=c(e.onTimeout,1e3)},function(t){var n;return e.isLoading=!1,e.isSuccessful=!1,console.error("Image Failed",t),console.info("Preload Failure"),n=c(e.onTimeout,1e3)},function(t){return e.percentLoaded=t.percent,console.info("Percent loaded:",t.percent)})}),e.secondsLeft=15e4,m=null,e.onTimeout=function(){return e.secondsLeft--,e.secondsLeft>=1?m=c(e.onTimeout,1e3):(e.stop(),s.increment("lives",-1),l.open("out of time!"),c(function(){return s.get("lives")>0?i.transitionTo("end",{tag:d.name,before:p,win:!1}):i.transitionTo("lose")},1e3))},e.stop=function(){return c.cancel(m)},e.correct=!1,e.guess="",e.computePoints=function(e,t,n){return Math.floor(e+e*(t/n))},e.updateGuess=function(t){return t&&0!==t.length?-1!==t.search(f)?(e.correct=!0,s.increment("current_round",1),s.increment("score",e.computePoints(10,e.secondsLeft,10)),e.stop(),l.open("correct!"),c(function(){return i.transitionTo("end",{tag:d.name,before:p,win:!0})},1e3)):void 0:0}}return e.$inject=["$scope","$templateCache","TagsService","RandomDateService","RoundsRes","gameStorage","$state","$stateParams","$timeout","imagePreloader","Modal"],e}(),o.controller("RoundCtrl",e)}).call(this);