(function(){var e,n;n=angular.module("tumblrGame.rounds"),e=function(){function e(e,n,t,o,r,s,a,u,i,c){var l,d,f,p;n.isLoading=!0,n.isSuccessful=!1,n.percentLoaded=0,Mousetrap.bind("backspace",function(e){var n,t;return n=e.srcElement||e.target,t="INPUT"===n.tagName.toUpperCase()&&"TEXT"===n.type.toUpperCase()?n.readOnly||n.disabled:!0,t?e.preventDefault():void 0}),n.round=s.get("current_round"),n.category=u.category,l=u.before,d=t.tag(n.category,u.index),f=new RegExp("^#?"+d.regex.source+"$","i"),e.addItem("round",u.category,d,1),n.posts=[],r.jsonp_query({tag:d.name,before:l},function(e){var t,o,r,s,a;for(n.message=e.meta,a=e.response,r=0,s=a.length;s>r&&(o=a[r],!("photo"===o.type&&(n.posts.push(o),n.posts.length>=6)));r++);return t=n.posts.map(function(e){return e.photos[0].alt_sizes[1].url}),c.preloadImages(t).then(function(){var e;return n.isLoading=!1,n.isSuccessful=!0,console.info("Preload Successful"),e=i(n.onTimeout,1e3)},function(e){var t;return n.isLoading=!1,n.isSuccessful=!1,console.error("Image Failed",e),console.info("Preload Failure"),t=i(n.onTimeout,1e3)},function(e){return n.percentLoaded=e.percent,console.info("Percent loaded:",e.percent)})}),n.secondsLeft=15,p=null,n.onTimeout=function(){return n.secondsLeft--,n.secondsLeft>=1?p=i(n.onTimeout,1e3):(n.stop(),s.increment("lives",-1),n.status="lost",i(function(){return s.get("lives")>0?a.transitionTo("end",{tag:d.name,before:l,win:!1}):a.transitionTo("lose")},500))},n.stop=function(){return i.cancel(p)},n.status="playing",n.guess="",n.computePoints=function(e,n,t){return Math.floor(e+e*(n/t))},n.updateGuess=function(e){return e&&0!==e.length?-1!==e.search(f)?(n.status="won",s.increment("current_round",1),s.increment("score",n.computePoints(10,n.secondsLeft,10)),n.stop(),i(function(){return a.transitionTo("end",{tag:d.name,before:l,win:!0})},500)):void 0:0}}return e.$inject=["Analytics","$scope","TagsService","RandomDateService","RoundsRes","gameStorage","$state","$stateParams","$timeout","imagePreloader"],e}(),n.controller("RoundCtrl",e)}).call(this);