(function(){var e,o;o=angular.module("tumblrGame.rounds"),e=function(){function e(e,o,t,n,r,s,a,u,c,i,l,d){var p,g,m,f;e.isLoading=!0,e.isSuccessful=!1,e.percentLoaded=0,e.round=u.get("current_round"),e.type=i.type||"series",g=n.random_tag(e.type),m=new RegExp("^#?"+g.regex.source+"$","i"),p=r.fromPastMonths(12),e.posts=[],s.jsonp_query({tag:g.name,before:p},function(o){var t,n,r,s,a;for(e.message=o.meta,a=o.response,r=0,s=a.length;s>r&&(n=a[r],!("photo"===n.type&&(e.posts.push(n),e.posts.length>=6)));r++);return t=e.posts.map(function(e){return e.photos[0].alt_sizes[1].url}),d.preloadImages(t).then(function(){var o;return e.isLoading=!1,e.isSuccessful=!0,console.info("Preload Successful"),o=l(e.onTimeout,1e3)},function(o){var t;return e.isLoading=!1,e.isSuccessful=!1,console.error("Image Failed",o),console.info("Preload Failure"),t=l(e.onTimeout,1e3)},function(o){return e.percentLoaded=o.percent,console.info("Percent loaded:",o.percent)})}),e.secondsLeft=10,f=null,e.onTimeout=function(){return e.secondsLeft--,e.secondsLeft>=1?f=l(e.onTimeout,1e3):(e.stop(),c.transitionTo("end",{tag:g.name,before:p,win:!1}))},e.stop=function(){return l.cancel(f)},e.correct=!1,e.guess="",e.updateGuess=function(o){return o&&0!==o.length?-1!==o.search(m)?(e.correct=!0,u.increment("current_round",1),e.stop(),c.transitionTo("end",{tag:g.name,before:p,win:!0})):void 0:0},e.storyline=a.get_story(e.round,"start"),o.open({template:t.get("storyline/story.tpl.html"),controller:"StoryCtrl",className:"story "+e.storyline.dialogs[0].type,plain:!0,scope:e,showClose:!1})}return e.$inject=["$scope","ngDialog","$templateCache","TagsService","RandomDateService","RoundsRes","StoryService","gameStorage","$state","$stateParams","$timeout","imagePreloader"],e}(),o.controller("RoundCtrl",e)}).call(this);