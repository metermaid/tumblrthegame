(function(){var e,n;n=angular.module("tumblrGame.rounds"),e=function(){function e(e,n,t,o,r,s,a,c,u,i){var l,d,p,f;e.isLoading=!0,e.isSuccessful=!1,e.percentLoaded=0,Mousetrap.unbind("backspace").bind("backspace",function(e){var n,t;return n=e.srcElement||e.target,t="INPUT"===n.tagName.toUpperCase()&&"TEXT"===n.type.toUpperCase()?n.readOnly||n.disabled:!0,t?e.preventDefault():void 0}),e.round=s.get("current_round"),e.category=c.category,l=c.before,d=t.tag(e.category,c.index),p=new RegExp("^#?"+d.regex.source+"$","i"),e.posts=[],r.jsonp_query({tag:d.name,before:l},function(n){var t,o,r,s,a;for(e.message=n.meta,a=n.response,r=0,s=a.length;s>r&&(o=a[r],!("photo"===o.type&&(e.posts.push(o),e.posts.length>=6)));r++);return t=e.posts.map(function(e){return e.photos[0].alt_sizes[1].url}),i.preloadImages(t).then(function(){var n;return e.isLoading=!1,e.isSuccessful=!0,console.info("Preload Successful"),n=u(e.onTimeout,1e3)},function(n){var t;return e.isLoading=!1,e.isSuccessful=!1,console.error("Image Failed",n),console.info("Preload Failure"),t=u(e.onTimeout,1e3)},function(n){return e.percentLoaded=n.percent,console.info("Percent loaded:",n.percent)})}),e.secondsLeft=15,f=null,e.onTimeout=function(){return e.secondsLeft--,e.secondsLeft>=1?f=u(e.onTimeout,1e3):(e.stop(),s.increment("lives",-1),s.get("lives")>0?a.transitionTo("end",{tag:d.name,before:l,win:!1}):a.transitionTo("lose"))},e.stop=function(){return u.cancel(f)},e.correct=!1,e.guess="",e.computePoints=function(e,n,t){return Math.floor(e+e*(n/t))},e.updateGuess=function(n){return n&&0!==n.length?-1!==n.search(p)?(e.correct=!0,s.increment("current_round",1),s.increment("score",e.computePoints(10,e.secondsLeft,10)),e.stop(),a.transitionTo("end",{tag:d.name,before:l,win:!0})):void 0:0}}return e.$inject=["$scope","$templateCache","TagsService","RandomDateService","RoundsRes","gameStorage","$state","$stateParams","$timeout","imagePreloader"],e}(),n.controller("RoundCtrl",e)}).call(this);